# How to Apply the Database Migration

## Quick Method: Supabase SQL Editor (RECOMMENDED)

### Step 1: Open Supabase SQL Editor
1. Go to: https://app.supabase.com/project/djguquclcyhwqijnobcp/sql/new
2. Or navigate to: **Supabase Dashboard â†’ Your Project â†’ SQL Editor â†’ New Query**

### Step 2: Copy the Migration SQL
Open the file: `migrations/add_task_roadmap_phase_columns.sql`

Or copy this SQL directly:

```sql
-- =====================================================
-- ADD ROADMAP PHASE LINKING AND ASSIGNMENT TO TASKS
-- =====================================================
-- Run this SQL in your Supabase SQL Editor
-- This migration adds:
-- 1. roadmap_phase_index - links tasks to specific roadmap phases
-- 2. assigned_to - assigns tasks to specific partners
-- 3. priority - task priority (low, medium, high)
-- =====================================================

-- Add new columns to tasks table
ALTER TABLE public.tasks
ADD COLUMN IF NOT EXISTS roadmap_phase_index INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS assigned_to TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high'));

-- Add comment for clarity
COMMENT ON COLUMN public.tasks.roadmap_phase_index IS
'Index of the roadmap phase this task belongs to (from milestone.deep_dive_data.roadmapPhases array). NULL means task is not linked to a specific phase.';

COMMENT ON COLUMN public.tasks.assigned_to IS
'Name of the partner this task is assigned to. NULL means assigned to both partners.';

COMMENT ON COLUMN public.tasks.priority IS
'Priority level of the task: low, medium, or high';

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_tasks_roadmap_phase ON public.tasks(milestone_id, roadmap_phase_index);
CREATE INDEX IF NOT EXISTS idx_tasks_assigned_to ON public.tasks(assigned_to);

-- Migration complete
SELECT 'Migration completed: tasks table now supports roadmap phase linking and partner assignment' AS status;
```

### Step 3: Run the Migration
1. Paste the SQL into the Supabase SQL Editor
2. Click the **"Run"** button (or press Ctrl+Enter)
3. You should see: **"Migration completed: tasks table now supports roadmap phase linking and partner assignment"**

### Step 4: Verify the Migration
Run this query to confirm the columns were added:

```sql
SELECT
  column_name,
  data_type,
  column_default
FROM information_schema.columns
WHERE table_name = 'tasks'
  AND column_name IN ('roadmap_phase_index', 'assigned_to', 'priority')
ORDER BY column_name;
```

Expected result:
| column_name | data_type | column_default |
|-------------|-----------|----------------|
| assigned_to | text | NULL |
| priority | text | 'medium' |
| roadmap_phase_index | integer | NULL |

## Alternative Method: Command Line (If you prefer)

If you have `psql` installed:

```bash
# Get your database connection string from Supabase
# Dashboard â†’ Project Settings â†’ Database â†’ Connection String

psql "postgresql://postgres:[YOUR-PASSWORD]@db.djguquclcyhwqijnobcp.supabase.co:5432/postgres" \
  -f migrations/add_task_roadmap_phase_columns.sql
```

## After Migration is Applied

### Test the Feature Flow:

1. **Refresh your app** at http://localhost:3000
2. **Navigate to a Milestone** that has roadmap phases (generated by Luna)
3. **Go to the "Roadmap" tab**
4. **Expand any phase** (click on it)
5. **Click "Add Task to This Phase"**
6. **Fill in the form:**
   - Task Title: "Test task"
   - Assign To: Select a partner
   - Priority: Select priority level
7. **Click "Save Task"**
8. **Verify:**
   - Task appears in the phase
   - Progress bar updates
   - Task shows in "Tasks" tab

### Troubleshooting

**If you see errors when creating tasks:**
- Check browser console for errors
- Verify migration ran successfully
- Check Supabase logs: Dashboard â†’ Logs â†’ Database

**If columns aren't showing:**
- Refresh the Supabase dashboard
- Re-run the verification query above
- Check for error messages in SQL Editor

**If tasks don't appear:**
- Check browser network tab for API errors
- Verify `getTasksByMilestone` is working
- Check Supabase Auth (make sure you're logged in)

## Migration Status Checklist

- [ ] Migration SQL copied
- [ ] Supabase SQL Editor opened
- [ ] Migration executed successfully
- [ ] Verification query shows 3 new columns
- [ ] App refreshed
- [ ] Test task created successfully
- [ ] Task appears in roadmap phase
- [ ] Progress bar updates correctly

Once all checkboxes are complete, you're ready to use the feature! ðŸŽ‰
